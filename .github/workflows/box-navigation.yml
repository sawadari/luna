name: ğŸ“¦ CrePS Box Navigation

# CrePS 6-Box Navigation Automation
# BoxNavigatorAgentã‚’è‡ªå‹•å®Ÿè¡Œã—ã¦Boxé·ç§»ã‚’ç®¡ç†

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  pull_request:
    types: [opened, ready_for_review, closed]
  schedule:
    # 1æ™‚é–“ã”ã¨ã«æ»ç•™ç›£è¦–
    - cron: '0 * * * *'

permissions:
  issues: write
  pull-requests: write

jobs:
  # ==========================================================================
  # 1. Box Navigation - Issue/PRä½œæˆãƒ»æ›´æ–°æ™‚
  # ==========================================================================

  box-navigation:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'pull_request'
    name: Box Navigation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run BoxNavigatorAgent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          npm run agents:box-nav -- --issue=${ISSUE_NUMBER}

      - name: Upload navigation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: box-navigation-result-${{ github.event.issue.number || github.event.pull_request.number }}
          path: .ai/box-navigation-*.json
          retention-days: 7

  # ==========================================================================
  # 2. Initial Box Assignment - æ–°è¦Issueä½œæˆæ™‚
  # ==========================================================================

  initial-box-assignment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    name: Initial Box Assignment (B1)

    steps:
      - name: Assign B1 label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              labels: ['Box:B1-RealProblem']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `ğŸ¯ **CrePS Boxå‰²ã‚Šå½“ã¦: B1 (Real Problem)**

ã“ã®Issueã¯**B1: Real Problemï¼ˆç¾å®Ÿå•é¡Œç©ºé–“ï¼‰**ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆB1 â†’ B2ï¼‰**:
1. Issueæœ¬æ–‡ã«ã€Œ## å•é¡Œå®šç¾©ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
2. ç¾çŠ¶ï¼ˆCurrent stateï¼‰ã‚’è¨˜è¿°ï¼ˆ50æ–‡å­—ä»¥ä¸Šï¼‰
3. ç›®æ¨™ï¼ˆTarget stateï¼‰ã‚’è¨˜è¿°ï¼ˆ50æ–‡å­—ä»¥ä¸Šï¼‰
4. åˆ¶ç´„ï¼ˆConstraintsï¼‰ã‚’è¨˜è¿°

**DESTçµ±åˆ**:
- ã€Œ## Outcome Assessmentã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¿½åŠ æ¨å¥¨
- ã€Œ## Safety Assessmentã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¿½åŠ æ¨å¥¨

è©³ç´°: [BoxNavigatorAgentä»•æ§˜](.claude/agents/box-navigator-agent.md)

---
*è‡ªå‹•æŠ•ç¨¿: Box Navigation Workflow*`
            });

  # ==========================================================================
  # 3. PR Creation - B4ã¸ã®è‡ªå‹•é·ç§»
  # ==========================================================================

  pr-box-transition:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    name: PR Created - Box Transition

    steps:
      - name: Find linked issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/#(\d+)/);
            if (match) {
              return match[1];
            }
            return null;
          result-encoding: string

      - name: Add B4 label to linked issue
        if: steps.find-issue.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.find-issue.outputs.result }}');

            // B3ãƒ©ãƒ™ãƒ«å‰Šé™¤
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: issueNumber,
                name: 'Box:B3-SolutionIdeas'
              });
            } catch (error) {
              // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
            }

            // B4ãƒ©ãƒ™ãƒ«è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: issueNumber,
              labels: ['Box:B4-DevelopedSolution']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: issueNumber,
              body: `ğŸ¯ **Boxé·ç§»: B3 â†’ B4**

Pull Request #${{ github.event.pull_request.number }} ãŒä½œæˆã•ã‚ŒãŸãŸã‚ã€**B4: Developed Solutionï¼ˆé–‹ç™ºã•ã‚ŒãŸè§£æ±ºç­–ï¼‰**ã¸é·ç§»ã—ã¾ã—ãŸã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆB4 â†’ B5ï¼‰**:
1. ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã‚’å®Œäº†
2. DraftçŠ¶æ…‹ã‚’è§£é™¤
3. ReviewAgentã«ã‚ˆã‚‹å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆ80ç‚¹ä»¥ä¸Šï¼‰

---
*è‡ªå‹•æŠ•ç¨¿: Box Navigation Workflow*`
            });

  # ==========================================================================
  # 4. PR Merged - B6ã¸ã®è‡ªå‹•é·ç§»
  # ==========================================================================

  pr-merged-box-transition:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    name: PR Merged - Box Transition

    steps:
      - name: Find linked issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/#(\d+)/);
            if (match) {
              return match[1];
            }
            return null;
          result-encoding: string

      - name: Add B6 label to linked issue
        if: steps.find-issue.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.find-issue.outputs.result }}');

            // B5ãƒ©ãƒ™ãƒ«å‰Šé™¤
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: issueNumber,
                name: 'Box:B5-ImplementedSolution'
              });
            } catch (error) {
              // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
            }

            // B6ãƒ©ãƒ™ãƒ«è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: issueNumber,
              labels: ['Box:B6-AcceptedSolution']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: issueNumber,
              body: `ğŸ¯ **Boxé·ç§»: B5 â†’ B6**

Pull Request #${{ github.event.pull_request.number }} ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸãŸã‚ã€**B6: Accepted Solutionï¼ˆå—ã‘å…¥ã‚Œã‚‰ã‚ŒãŸè§£æ±ºç­–ï¼‰**ã¸é·ç§»ã—ã¾ã—ãŸã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆB6 â†’ Doneï¼‰**:
1. ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’ç¢ºèª
2. æœ¬ç•ªå‹•ä½œç¢ºèª
3. AL2ç¶­æŒã‚’ç¢ºèªï¼ˆDESTAgentå†å®Ÿè¡Œï¼‰

---
*è‡ªå‹•æŠ•ç¨¿: Box Navigation Workflow*`
            });

  # ==========================================================================
  # 5. Dwell Time Monitoring - 1æ™‚é–“ã”ã¨ã®æ»ç•™ç›£è¦–
  # ==========================================================================

  dwell-time-monitoring:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    name: Box Dwell Time Monitoring

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Monitor all open issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run agents:box-nav -- --monitor

      - name: Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: box-dwell-monitoring-${{ github.run_id }}
          path: .ai/box-monitoring-*.json
          retention-days: 30
