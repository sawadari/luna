name: ğŸ“‹ Planning Layer Automation

# Planning Layer: Decision Management & Assumption Tracking
# Automatically manage Opportunities, Options, Decisions, and Assumptions

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  pull_request:
    types: [opened, edited]
  schedule:
    # 1æ—¥1å›ã€Assumptionæ¤œè¨¼æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
    - cron: '0 0 * * *'

permissions:
  issues: write
  pull-requests: write

jobs:
  # ==========================================================================
  # 1. Planning Layer - Issue/PRä½œæˆãƒ»æ›´æ–°æ™‚
  # ==========================================================================

  planning-layer:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'pull_request'
    name: Planning Layer Processing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run PlanningAgent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          npm run agents:planning -- --issue=${ISSUE_NUMBER}

      - name: Upload planning result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: planning-result-${{ github.event.issue.number || github.event.pull_request.number }}
          path: .ai/planning-*.json
          retention-days: 7

  # ==========================================================================
  # 2. Initial Planning - æ–°è¦Issueä½œæˆæ™‚
  # ==========================================================================

  initial-planning:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    name: Initial Planning Setup

    steps:
      - name: Add planning guidance comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `ğŸ“‹ **Planning Layer ã‚¬ã‚¤ãƒ‰**

ã“ã®Issueã§ã¯ **Planning Layer** ã‚’ä½¿ç”¨ã—ã¦æ„æ€æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚

## ğŸ“ Opportunity å®šç¾©

ã¾ãšã€ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„:

\`\`\`markdown
## å•é¡Œå®šç¾©
- Current state: ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¨˜è¿°
- Target state: ç›®æ¨™ã®çŠ¶æ…‹ã‚’è¨˜è¿°
- Target Customer: èª°ã®ãŸã‚ã®è§£æ±ºç­–ã‹
- Constraints: åˆ¶ç´„æ¡ä»¶
\`\`\`

## ğŸ’¡ Options è¿½åŠ 

æ¬¡ã«ã€è§£æ±ºç­–ã®é¸æŠè‚¢ã‚’è¿½åŠ :

\`\`\`markdown
## è§£æ±ºã‚¢ã‚¤ãƒ‡ã‚¢

### Option 1: [ã‚¿ã‚¤ãƒˆãƒ«]
**Hypothesis**: ãªãœã“ã‚ŒãŒæ©Ÿèƒ½ã™ã‚‹ã¨è€ƒãˆã‚‹ã‹

**Pros**:
- åˆ©ç‚¹1
- åˆ©ç‚¹2

**Cons**:
- æ¬ ç‚¹1

**Risks**:
- ãƒªã‚¹ã‚¯1

**Assumptions**:
- ä»®å®š1 (ä¾‹: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®80%ãŒã“ã®æ©Ÿèƒ½ã‚’ä½¿ã†")
\`\`\`

## âœ… Decision é¸æŠ

æœ€é©ãª Option ã‚’é¸ã‚“ã ã‚‰ã€âœ… ãƒãƒ¼ã‚¯ã‚’è¿½åŠ :

\`\`\`markdown
- âœ… **Option 1**: Chosen option
- Option 2: Alternative
\`\`\`

PlanningAgent ãŒè‡ªå‹•çš„ã« DecisionRecord ã‚’ä½œæˆã—ã¾ã™ã€‚

## ğŸ” Assumption è¿½è·¡

"assuming that..." ã‚„ "ä»®å®šã¨ã—ã¦..." ãªã©ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä½¿ã†ã¨ã€
AssumptionTrackerAgent ãŒè‡ªå‹•çš„ã«è¿½è·¡ã‚’é–‹å§‹ã—ã¾ã™ã€‚

---
*Automated by Planning Layer*`
            });

  # ==========================================================================
  # 3. Planning at B3 - Solution Ideas Box
  # ==========================================================================

  planning-at-b3:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'Box:B3-SolutionIdeas')
    name: Planning at B3 (Solution Ideas)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Trigger PlanningAgent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run agents:planning -- --issue=${{ github.event.issue.number }}

      - name: Add planning reminder
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `ğŸ“‹ **B3 (Solution Ideas) - Planning Reminder**

ã“ã®Boxã§ã¯ã€ä»¥ä¸‹ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„:

1. **Options**: 3å€‹ä»¥ä¸Šã®è§£æ±ºç­–ã‚’è¿½åŠ 
2. **Leverage Point åˆ†æ**: å„Optionã®ä»‹å…¥ãƒ¬ãƒ™ãƒ«ã‚’ç¢ºèª
3. **Assumptions**: å„Optionã®å‰ææ¡ä»¶ã‚’æ˜è¨˜
4. **Decision**: æœ€é©ãªOptionã‚’é¸æŠï¼ˆâœ… ãƒãƒ¼ã‚¯ï¼‰

å®Œäº†å¾Œã€PlanningAgentãŒè‡ªå‹•çš„ã«DecisionRecordã‚’ä½œæˆã—ã¾ã™ã€‚

---
*Automated by Planning Layer*`
            });

  # ==========================================================================
  # 4. Assumption Tracking - å®šæœŸãƒã‚§ãƒƒã‚¯
  # ==========================================================================

  assumption-tracking:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    name: Assumption Validation Tracking

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Track all open issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run agents:assumption -- --monitor

      - name: Upload tracking report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assumption-tracking-${{ github.run_id }}
          path: .ai/assumption-tracking-*.json
          retention-days: 30

  # ==========================================================================
  # 5. Decision Label Sync
  # ==========================================================================

  decision-label-sync:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      startsWith(github.event.label.name, 'Decision:')
    name: Decision Label Applied

    steps:
      - name: Record decision
        uses: actions/github-script@v7
        with:
          script: |
            const label = context.payload.label.name;
            const decisionType = label.replace('Decision:', '');

            let emoji = '';
            let message = '';

            switch(decisionType) {
              case 'Adopt':
                emoji = 'âœ…';
                message = 'ã“ã® Option ãŒæ¡ç”¨ã•ã‚Œã¾ã—ãŸ';
                break;
              case 'Defer':
                emoji = 'â¸ï¸';
                message = 'æ±ºå®šãŒå»¶æœŸã•ã‚Œã¾ã—ãŸ';
                break;
              case 'Reject':
                emoji = 'âŒ';
                message = 'ã“ã® Option ã¯å´ä¸‹ã•ã‚Œã¾ã—ãŸ';
                break;
              case 'Explore':
                emoji = 'ğŸ”';
                message = 'ã•ã‚‰ãªã‚‹èª¿æŸ»ãŒå¿…è¦ã§ã™';
                break;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `${emoji} **Decision Label Applied: ${decisionType}**

${message}

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
- Adopt: å®Ÿè£…è¨ˆç”»ã‚’ä½œæˆã€B4ã¸é·ç§»
- Defer: å†è©•ä¾¡æ—¥ã‚’è¨­å®š
- Reject: ä»£æ›¿æ¡ˆã‚’æ¤œè¨
- Explore: èª¿æŸ»ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ

---
*Automated by Planning Layer*`
            });

  # ==========================================================================
  # 6. Assumption Invalidation Alert
  # ==========================================================================

  assumption-invalidation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'Assumption:Invalidated')
    name: Assumption Invalidation Alert

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run impact analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run agents:assumption -- --issue=${{ github.event.issue.number }} --impact-analysis

      - name: Escalate to Product Owner
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              labels: ['ğŸš¨escalated', 'ğŸ‘‘needs-product-owner']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `ğŸš¨ **Assumption Invalidation - Product Owner Escalation**

é‡è¦ãª Assumption ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸã€‚

@${{ github.repository_owner }} - ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
1. ç„¡åŠ¹åŒ–ã•ã‚ŒãŸ Assumption ã®å½±éŸ¿ç¯„å›²
2. é–¢é€£ã™ã‚‹ DecisionRecord ã®å¦¥å½“æ€§
3. ä»£æ›¿æ¡ˆã®å¿…è¦æ€§

**Action Required**:
- é–¢é€£ã™ã‚‹ Decision ã‚’å†è©•ä¾¡
- å¿…è¦ã«å¿œã˜ã¦ Planning ã‚’å†å®Ÿè¡Œ

---
*Automated by Planning Layer*`
            });
