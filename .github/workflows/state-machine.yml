name: ğŸ”„ State Machine Automation

# Automatically manage Issue/PR state based on labels
# Constitutional requirement: "Labels are the OS's state management"
#
# Phase 2: CrePS Box Integration
# - miyabi state labels work alongside CrePS Box labels
# - Box labels (B1-B6) managed by box-navigation.yml
# - Box-State mapping:
#   - pending â†’ B1 (Real Problem)
#   - analyzing â†’ B2 (Defined Problem) â†’ B3 (Solution Ideas)
#   - implementing â†’ B4 (Developed Solution) â†’ B5 (Implemented Solution)
#   - testing/deploying â†’ B5 â†’ B6 (Accepted Solution)
#   - done â†’ B6 + G6 passed + AL2

on:
  issues:
    types: [opened, labeled, unlabeled, assigned, closed, reopened]
  pull_request:
    types: [opened, labeled, unlabeled, closed, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  # ==========================================================================
  # 1. Initial Triage - New Issues
  # ==========================================================================

  initial-triage:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    name: Initial Triage

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set initial state to pending
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run state:transition -- \
            --issue=${{ github.event.issue.number }} \
            --to=pending \
            --reason="New issue created, awaiting triage"

      - name: Auto-assign priority
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            let priority = 'ğŸ“Š priority:P2-Medium';

            // Check for priority indicators in title/body
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();

            if (title.includes('critical') || body.includes('production down') || body.includes('security')) {
              priority = 'ğŸ”¥ priority:P0-Critical';
            } else if (title.includes('urgent') || title.includes('bug') || body.includes('broken')) {
              priority = 'âš ï¸ priority:P1-High';
            } else if (title.includes('enhancement') || title.includes('feature')) {
              priority = 'ğŸ“Š priority:P2-Medium';
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              labels: [priority]
            });

  # ==========================================================================
  # 2. Coordinator Assignment - Trigger Analysis
  # ==========================================================================

  coordinator-assignment:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'agent:coordinator')
    name: Coordinator Assignment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Transition to analyzing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run state:transition -- \
            --issue=${{ github.event.issue.number }} \
            --to=analyzing \
            --reason="CoordinatorAgent assigned, starting analysis"

  # ==========================================================================
  # 3. Specialist Assignment - Start Implementation
  # ==========================================================================

  specialist-assignment:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      (contains(github.event.label.name, 'agent:codegen') ||
       contains(github.event.label.name, 'agent:issue') ||
       contains(github.event.label.name, 'agent:pr'))
    name: Specialist Assignment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Transition to implementing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run state:transition -- \
            --issue=${{ github.event.issue.number }} \
            --to=implementing \
            --reason="Specialist agent assigned, starting implementation"

  # ==========================================================================
  # 4. PR Created - Start Review
  # ==========================================================================

  pr-created:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    name: PR Created - Start Review

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Find linked issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/#(\d+)/);
            if (match) {
              return match[1];
            }
            return null;
          result-encoding: string

      - name: Transition linked issue to reviewing
        if: steps.find-issue.outputs.result != 'null'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run state:transition -- \
            --issue=${{ steps.find-issue.outputs.result }} \
            --to=reviewing \
            --reason="PR #${{ github.event.pull_request.number }} created"

      - name: Add review agent label to PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.pull_request.number,
              labels: ['ğŸ¤– agent:review', 'ğŸ‘€ state:reviewing']
            });

  # ==========================================================================
  # 5. PR Merged - Mark as Done
  # ==========================================================================

  pr-merged:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    name: PR Merged - Mark Done

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Find linked issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/#(\d+)/);
            if (match) {
              return match[1];
            }
            return null;
          result-encoding: string

      - name: Transition linked issue to done
        if: steps.find-issue.outputs.result != 'null'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          npm run state:transition -- \
            --issue=${{ steps.find-issue.outputs.result }} \
            --to=done \
            --reason="PR #${{ github.event.pull_request.number }} merged successfully"

  # ==========================================================================
  # 6. Blocked Label - Escalate
  # ==========================================================================

  blocked-escalation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'state:blocked')
    name: Blocked - Escalate

    steps:
      - name: Create escalation comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `ğŸš¨ **BLOCKED - Guardian Escalation**

              This issue has been marked as blocked and requires Guardian intervention.

              @${{ github.repository_owner }} - Please review and resolve.

              **Next Steps**:
              1. Review blocker reason
              2. Resolve dependencies or technical issues
              3. Remove \`ğŸ”´ state:blocked\` label when ready
              4. Add appropriate state label to resume

              ---
              *Automated by [State Machine](../.github/workflows/state-machine.yml)*`
            });

      - name: Add severity label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              labels: ['âš ï¸ severity:Sev.2-High']
            });

  # ==========================================================================
  # 7. AL Gate Check - Block implementing if AL0
  # ==========================================================================

  al-gate-check-implementing:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'state:implementing')
    name: AL Gate Check (Implementing)

    steps:
      - name: Check AL status
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);

            // Check if Issue has AL0 label
            if (labels.includes('AL:AL0-NotAssured')) {
              console.log('âŒ AL0 detected - Blocking implementing state');

              // Remove implementing label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  issue_number: context.payload.issue.number,
                  name: 'ğŸ—ï¸ state:implementing'
                });
              } catch (error) {
                console.log('Label removal failed:', error.message);
              }

              // Add blocked label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: context.payload.issue.number,
                labels: ['ğŸš« state:blocked']
              });

              // Post blocking comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: context.payload.issue.number,
                body: `ğŸš« **Implementation Blocked: AL0 Gate Check Failed**

This issue cannot proceed to \`implementing\` state because it has **AL:AL0-NotAssured** status.

**Required Actions**:
1. Resolve the AL0 Reason(s) identified in the DEST judgment
2. Follow the Protocol instructions (P0-P4)
3. Re-evaluate using DESTAgent
4. Achieve AL1 (Qualified) or AL2 (Assured) status

**AL0 Reasons**:
${labels.filter(l => l.startsWith('AL0:')).map(l => \`- ${l}\`).join('\\n') || 'See DEST judgment comment'}

**Protocol**:
${labels.filter(l => l.startsWith('Protocol:')).join(', ') || 'See DEST judgment comment'}

---
*Automated by [State Machine AL Gate](.github/workflows/state-machine.yml)*`
              });

              core.setFailed('AL0 blocks implementation');
            } else {
              console.log('âœ… AL gate check passed (AL1 or AL2)');
            }

  # ==========================================================================
  # 8. AL Gate Check - Block deploying if not AL2
  # ==========================================================================

  al-gate-check-deploying:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'state:deploying')
    name: AL Gate Check (Deploying)

    steps:
      - name: Check AL2 status
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);

            // Check if Issue has AL2 label
            if (!labels.includes('AL:AL2-Assured')) {
              console.log('âŒ AL2 not detected - Blocking deploying state');

              // Remove deploying label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  issue_number: context.payload.issue.number,
                  name: 'ğŸš€ state:deploying'
                });
              } catch (error) {
                console.log('Label removal failed:', error.message);
              }

              // Add blocked label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: context.payload.issue.number,
                labels: ['ğŸš« state:blocked']
              });

              // Determine current AL
              let currentAL = 'unknown';
              if (labels.includes('AL:AL0-NotAssured')) {
                currentAL = 'AL0 (Not Assured)';
              } else if (labels.includes('AL:AL1-Qualified')) {
                currentAL = 'AL1 (Qualified)';
              }

              // Post blocking comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: context.payload.issue.number,
                body: `ğŸš« **Deployment Blocked: AL2 Gate Check Failed**

This issue cannot proceed to \`deploying\` state because it does not have **AL:AL2-Assured** status.

**Current AL**: ${currentAL}

**Required Actions**:
1. Ensure all testing is complete with successful results
2. Verify system is progressing toward target state (outcome_ok)
3. Verify safety constraints are met (safety_ok)
4. Re-evaluate using DESTAgent to achieve AL2 status

**Deployment requires**:
- âœ… Outcome OK (progressing toward target)
- âœ… Safety OK (stable feedback loops, no violations)

---
*Automated by [State Machine AL Gate](.github/workflows/state-machine.yml)*`
              });

              core.setFailed('Deployment requires AL2');
            } else {
              console.log('âœ… AL2 gate check passed - Deployment approved');
            }
