# [P3] å¯¾è©±å‹Lunaé«˜åº¦æ©Ÿèƒ½ - ä¸¦åˆ—å®Ÿè¡Œ + æ°¸ç¶šåŒ– + Web UI (Phase 3)

## ğŸ“‹ æ¦‚è¦

Phase 2ã¾ã§ã®æ©Ÿèƒ½ã®ä¸Šã«ã€å°†æ¥çš„ãªæ‹¡å¼µæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä¸¦åˆ—å®Ÿè¡Œã€ä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–ã€ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œã€Web UIãªã©ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

**å‰ææ¡ä»¶**: Phase 2ï¼ˆIssue #7ï¼‰ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨

## ğŸ¯ Phase 3ã§è¿½åŠ ã™ã‚‹æ©Ÿèƒ½

### 1. è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä¸¦åˆ—å®Ÿè¡Œ

è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åŒæ™‚ã«å®Ÿè¡Œã—ã€çµæœã‚’çµ±åˆã—ã¾ã™ã€‚

**ä¾‹**:
```
User: "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒ†ã‚¹ãƒˆã‚’åŒæ™‚ã«å®Ÿè¡Œã—ã¦"
Luna: "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã—ã¾ã™..."
Luna: "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº† (5ç§’)"
Luna: "âœ… ãƒ†ã‚¹ãƒˆå®Œäº† (8ç§’)"
Luna: "çµ±åˆçµæœ: å“è³ªã‚¹ã‚³ã‚¢85ç‚¹ã€ã‚«ãƒãƒ¬ãƒƒã‚¸85.5%ã€å…¨ãƒ†ã‚¹ãƒˆé€šé"
```

### 2. ä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–

ä¼šè©±å±¥æ­´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã¾ãŸã„ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**åˆ©ç‚¹**:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã‚‚ä¼šè©±ã‚’ç¶™ç¶šã§ãã‚‹
- éå»ã®å®Ÿè¡Œçµæœã‚’å‚ç…§ã§ãã‚‹
- ãƒãƒ¼ãƒ å†…ã§ä¼šè©±å±¥æ­´ã‚’å…±æœ‰ã§ãã‚‹

### 3. ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«Lunaã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**æ©Ÿèƒ½**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- æ¨©é™ç®¡ç†ï¼ˆIssue #5 State Transition Authorityã¨é€£æºï¼‰

### 4. Web UIå®Ÿè£…

ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã®UIã§Lunaã¨å¯¾è©±ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**æ©Ÿèƒ½**:
- ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- å®Ÿè¡Œçµæœã®å¯è¦–åŒ–ï¼ˆã‚°ãƒ©ãƒ•ã€è¡¨ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã®é–²è¦§
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤º

## ğŸš€ å®Ÿè£…å†…å®¹

### 1. ä¸¦åˆ—å®Ÿè¡Œãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼

```typescript
// src/services/parallel-execution-manager.ts

export class ParallelExecutionManager {
  private agentRouter: AgentRouter;

  /**
   * è¤‡æ•°ã®ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
   */
  async executeParallel(intents: Intent[], session: ChatSession): Promise<AgentResult<any>[]> {
    const promises = intents.map(intent =>
      this.agentRouter.route(intent, session)
    );

    // ä¸¦åˆ—å®Ÿè¡Œ
    const results = await Promise.allSettled(promises);

    // çµæœã‚’é›†ç´„
    return results.map((result, index) => {
      if (result.status === 'fulfilled') {
        return result.value;
      } else {
        return {
          status: 'error',
          error: result.reason,
          metrics: {
            durationMs: 0,
            timestamp: new Date().toISOString(),
          },
        };
      }
    });
  }

  /**
   * çµæœã‚’çµ±åˆ
   */
  async aggregateResults(results: AgentResult<any>[]): Promise<ChatResponse> {
    const messages: string[] = [];
    let allSuccess = true;

    for (const result of results) {
      if (result.status === 'success') {
        messages.push(this.formatSuccessMessage(result));
      } else {
        messages.push(this.formatErrorMessage(result));
        allSuccess = false;
      }
    }

    return {
      message: messages.join('\n\n'),
      data: results,
      suggestedActions: allSuccess ? ['æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€'] : ['ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã™ã‚‹'],
    };
  }
}
```

### 2. æ°¸ç¶šåŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼

```typescript
// src/services/session-store.ts

import * as fs from 'fs/promises';
import * as path from 'path';

export class SessionStore {
  private storePath = 'sessions';

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
   */
  async saveSession(session: ChatSession): Promise<void> {
    const sessionFile = path.join(this.storePath, `${session.id}.json`);
    await fs.mkdir(this.storePath, { recursive: true });
    await fs.writeFile(sessionFile, JSON.stringify(session, null, 2), 'utf-8');
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
   */
  async loadSession(sessionId: string): Promise<ChatSession | null> {
    const sessionFile = path.join(this.storePath, `${sessionId}.json`);

    try {
      const content = await fs.readFile(sessionFile, 'utf-8');
      return JSON.parse(content);
    } catch (error) {
      return null;
    }
  }

  /**
   * å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
   */
  async listSessions(userId: string): Promise<ChatSession[]> {
    const files = await fs.readdir(this.storePath);
    const sessions: ChatSession[] = [];

    for (const file of files) {
      if (file.endsWith('.json')) {
        const session = await this.loadSession(file.replace('.json', ''));
        if (session && session.userId === userId) {
          sessions.push(session);
        }
      }
    }

    return sessions.sort((a, b) =>
      new Date(b.lastActivityAt).getTime() - new Date(a.lastActivityAt).getTime()
    );
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
   */
  async deleteSession(sessionId: string): Promise<void> {
    const sessionFile = path.join(this.storePath, `${sessionId}.json`);
    await fs.unlink(sessionFile);
  }
}
```

### 3. ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

```typescript
// src/services/user-manager.ts

export interface User {
  id: string;
  name: string;
  email: string;
  roles: Role[];  // Issue #5 State Transition Authorityã¨é€£æº
  createdAt: string;
}

export class UserManager {
  private users: Map<string, User> = new Map();

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
   */
  async authenticate(token: string): Promise<User | null> {
    // TODO: å®Ÿéš›ã®èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆJWTã€OAuthç­‰ï¼‰
    return null;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
   */
  async registerUser(user: User): Promise<void> {
    this.users.set(user.id, user);
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
   */
  async getUser(userId: string): Promise<User | null> {
    return this.users.get(userId) || null;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—
   */
  async getUserSessions(userId: string): Promise<ChatSession[]> {
    const sessionStore = new SessionStore();
    return await sessionStore.listSessions(userId);
  }
}
```

### 4. Web UIå®Ÿè£…

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆExpressï¼‰

```typescript
// src/web/server.ts

import express from 'express';
import { WebSocketServer } from 'ws';
import { ChatAgent } from '../agents/chat-agent';

const app = express();
const port = 3000;

app.use(express.json());
app.use(express.static('public'));

const chatAgent = new ChatAgent({
  githubToken: process.env.GITHUB_TOKEN || '',
  repository: process.env.GITHUB_REPOSITORY || '',
  verbose: true,
  dryRun: false,
});

// REST API
app.post('/api/chat', async (req, res) => {
  const { message, sessionId } = req.body;

  try {
    const response = await chatAgent.chat(message, sessionId);
    res.json(response);
  } catch (error) {
    res.status(500).json({ error: (error as Error).message });
  }
});

app.get('/api/sessions/:userId', async (req, res) => {
  const { userId } = req.params;
  const userManager = new UserManager();
  const sessions = await userManager.getUserSessions(userId);
  res.json(sessions);
});

// WebSocketï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—ï¼‰
const wss = new WebSocketServer({ port: 3001 });

wss.on('connection', (ws) => {
  console.log('WebSocket client connected');

  ws.on('message', async (message) => {
    const data = JSON.parse(message.toString());

    if (data.type === 'chat') {
      // é€²æ—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€ä¿¡
      ws.send(JSON.stringify({ type: 'progress', message: 'å‡¦ç†é–‹å§‹...' }));

      const response = await chatAgent.chat(data.message, data.sessionId);

      ws.send(JSON.stringify({ type: 'response', data: response }));
    }
  });
});

app.listen(port, () => {
  console.log(`Luna Web UI server running on http://localhost:${port}`);
});
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰

```typescript
// public/src/App.tsx

import React, { useState, useEffect } from 'react';

function App() {
  const [messages, setMessages] = useState<Array<{ role: 'user' | 'luna'; content: string }>>([]);
  const [input, setInput] = useState('');
  const [sessionId] = useState(() => `session-${Date.now()}`);
  const [ws, setWs] = useState<WebSocket | null>(null);

  useEffect(() => {
    const websocket = new WebSocket('ws://localhost:3001');

    websocket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'progress') {
        // é€²æ—è¡¨ç¤º
        console.log('Progress:', data.message);
      } else if (data.type === 'response') {
        setMessages((prev) => [
          ...prev,
          { role: 'luna', content: data.data.message },
        ]);
      }
    };

    setWs(websocket);

    return () => {
      websocket.close();
    };
  }, []);

  const sendMessage = () => {
    if (!input.trim() || !ws) return;

    setMessages((prev) => [...prev, { role: 'user', content: input }]);

    ws.send(JSON.stringify({
      type: 'chat',
      message: input,
      sessionId,
    }));

    setInput('');
  };

  return (
    <div className="app">
      <div className="chat-container">
        <div className="messages">
          {messages.map((msg, index) => (
            <div key={index} className={`message ${msg.role}`}>
              <strong>{msg.role === 'user' ? 'You' : 'Luna'}:</strong> {msg.content}
            </div>
          ))}
        </div>

        <div className="input-container">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
            placeholder="Lunaã«æŒ‡ç¤ºã‚’å…¥åŠ›..."
          />
          <button onClick={sendMessage}>é€ä¿¡</button>
        </div>
      </div>
    </div>
  );
}

export default App;
```

## âœ… Acceptance Criteria

- [ ] ParallelExecutionManager å®Ÿè£…å®Œäº†
- [ ] è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã§ãã‚‹
- [ ] SessionStore å®Ÿè£…å®Œäº†
- [ ] ä¼šè©±å±¥æ­´ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ°¸ç¶šåŒ–ã•ã‚Œã‚‹
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã¾ãŸã„ã§ä¼šè©±ã‚’ç¶™ç¶šã§ãã‚‹
- [ ] UserManager å®Ÿè£…å®Œäº†
- [ ] ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œãŒå‹•ä½œã™ã‚‹
- [ ] Web UI å®Ÿè£…å®Œäº†
  - [ ] Express ã‚µãƒ¼ãƒãƒ¼
  - [ ] WebSocket ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡
  - [ ] React ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰Lunaã¨å¯¾è©±ã§ãã‚‹
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤ºãŒå‹•ä½œã™ã‚‹
- [ ] TypeScript ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä½œæˆ
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

## ğŸ”— é–¢é€£Issue

- Issue #6: å¯¾è©±å‹Luna Phase 1
- Issue #7: å¯¾è©±å‹Luna Phase 2
- Issue #5: State Transition Authorityï¼ˆãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ç®¡ç†ã¨é€£æºï¼‰

## ğŸ“š å‚è€ƒè³‡æ–™

- `CONVERSATIONAL_LUNA_DESIGN.md` - è©³ç´°è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- Express.js: https://expressjs.com/
- React: https://react.dev/
- WebSocket: https://developer.mozilla.org/en-US/docs/Web/API/WebSocket

## å„ªå…ˆåº¦

**P3 - Low**: Phase 2ã®å®Œäº†å¾Œã«å®Ÿè£…ã€‚å°†æ¥çš„ãªæ‹¡å¼µæ©Ÿèƒ½ã€‚

---

**æ¨å®šå·¥æ•°**: 3-4é€±é–“
**Phase**: Conversational Luna Phase 3
