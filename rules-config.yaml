# Luna Rules Configuration
# Human-AI Responsibility Boundary Rules

meta:
  version: "1.0"
  last_updated: "2026-02-08"
  last_updated_by: "System"
  description: "Luna Human-AI Responsibility Boundary Rules"
  author: "Luna Team"

# ============================================================================
# Human-AI Responsibility Boundary
# ============================================================================

human_ai_boundary:
  # Phase 0: DEST Judgment
  # Issue実装前の価値判断（Problem Space分析）
  dest_judgment:
    enabled: true
    rationale: "Issue実装前の価値判断は人間の責任範囲。AL判定により実装の可否を決定する。"
    al_threshold:
      block_below: "AL0"        # AL0: 実装ブロック（safety NG）
      require_approval: "AL1"   # AL1: 人間承認必要（条件付き）
      auto_proceed: "AL2"       # AL2以上: 自動進行可能（保証あり）
    auto_label: true            # AL判定結果を自動的にIssueラベルに反映
    approval_detection:         # Issue #47: 承認検出設定
      labels:                   # 承認を示すラベル
        - "approved"
        - "AL1:approved"
        - "approval:granted"
      commands:                 # 承認を示すコメントコマンド
        - "/approve"

  # Phase 1: Planning Layer
  # 解決策探索（Solution Space分析）
  planning_layer:
    enabled: true
    rationale: "解決策探索は人間の意思決定支援が必要。CrePS 6-Boxで構造化する。"
    creps_gates:
      enabled: true
      threshold: 70             # 70点以下は人間レビュー必要
      auto_advance: false       # Gate通過時も人間確認を要求
    assumption_tracking:
      enabled: true
      rationale: "前提の無効化を追跡し、再評価を促す"

  # Phase 2: Kernel Generation (SSOT)
  # Kernelの自動生成と収束監視
  kernel_generation:
    enabled: true
    auto_extract_nrvv: true
    rationale: "NRVVはAIが提案、人間が承認する形式。Self-Improvementの基盤。"
    ai_extraction:
      enabled: true
      model: "claude-sonnet-4.5"
      fallback_to_template: true
      confidence_threshold: 0.7  # 信頼度70%以上でのみ自動生成
    convergence_monitoring:
      enabled: true
      threshold: 70              # 収束率70%以下でアラート
      check_interval: "weekly"   # 週次でチェック
    enhancement_service:
      enabled: true
      rationale: "既存KernelのNRVV補完をAIが提案"

  # Phase 3-5: Implementation
  # コード生成とレビュー
  code_generation:
    enabled: true
    rationale: "定型的な実装はAIが担当、ただしレビューは必須"
    quality_threshold: 80        # 80点以上で合格
    generate_tests: true
    test_coverage_target: 80     # カバレッジ80%を目標
    ai_model: "claude-sonnet-4.5"

  review_required:
    enabled: true
    rationale: "生成コードは必ず人間がレビュー。品質保証の最終責任は人間。"
    min_quality_score: 80
    require_human_approval: true
    automated_checks:
      - "lint"
      - "type_check"
      - "security_scan"

  # Phase 6-7: V&V (Verification & Validation)
  # 検証と妥当性確認
  auto_verification:
    enabled: true
    rationale: "テスト実行は自動化、結果判断は人間が行う"
    run_on_commit: true
    fail_on_coverage_drop: true
    coverage_threshold: 80
    auto_add_to_kernel: true  # テスト成功時に Verification を Kernel に自動記録

  auto_validation:
    enabled: false
    rationale: "Validation（妥当性確認）は人間の判断が必要"
    require_human_sign_off: true

  # Phase 8: Monitoring & Deployment
  # 継続的監視とデプロイ
  continuous_monitoring:
    enabled: true
    alert_to_human: true
    rationale: "異常検知時は人間にエスカレーション"
    alert_channels:
      - "github_issue"
      - "log"

  auto_deployment:
    enabled: false
    rationale: "デプロイは人間の明示的な承認が必要"
    environments:
      dev:
        enabled: true
        require_approval: false
      staging:
        enabled: true
        require_approval: true
      production:
        enabled: false
        require_approval: true

# ============================================================================
# Organization-specific Rules
# ============================================================================

organization_rules:
  # Issue/タスクの最大複雑度
  max_issue_complexity: "large"  # small/medium/large/xlarge

  # 人間承認が必要な変更
  require_approval_for:
    - "breaking changes"
    - "security-related"
    - "architecture changes"
    - "database schema changes"
    - "API changes"

  # 禁止操作
  forbidden_operations:
    - "force push to main"
    - "direct commit to main"
    - "skip tests"

  # ブランチ戦略
  branch_strategy:
    main_branch: "main"
    require_pull_request: true
    require_reviews: 1
    require_ci_pass: true

# ============================================================================
# Individual-specific Preferences (Optional)
# ============================================================================

individual_preferences:
  # ログレベル
  verbose_logging: false

  # デフォルト動作
  dry_run_default: false

  # 通知レベル
  notification_level: "important"  # all/important/critical

  # AI支援レベル
  ai_assistance_level: "balanced"  # minimal/balanced/maximal

  # 自動コメント
  auto_comment_on_pr: true
  auto_comment_on_issue: true

# ============================================================================
# Phase A-C: Core Architecture Rules (NEW)
# ============================================================================

core_architecture:
  # Kernel Runtime設定
  kernel_runtime:
    default_registry_path: "data/ssot/kernels-luna-base.yaml"
    default_ledger_path: "data/ssot/ledger.ndjson"
    solo_mode_default: false      # デフォルトは権限チェック有効
    enable_ledger_default: true   # Ledger記録を有効化

  # Issue一本道の強制
  issue_enforcement:
    enforce_issue_required: true
    rationale: "すべての変更はIssue経由で行う（トレーサビリティ確保）"

  # Bootstrap Kernel保護
  bootstrap_protection:
    enforce_bootstrap_protection: true
    rationale: "Bootstrap Kernelは不変（システムの根本ルール）"

  # AL0ブロック
  al0_gate:
    enabled: true
    rationale: "AL0（Not Assured）はstate transitionをブロック（安全性制約）"

  # Issue #49: Evidence Governance昇格ルール
  evidence_governance:
    enforce_ai_verification: true
    rationale: "AI生成物の未検証昇格を防止（品質保証）"
    allowed_unverified_sources:
      - "human"     # 人間生成物は検証なしでも昇格可能
    # Note: blocked_unverified_sources is deprecated in favor of strict whitelist mode.
    # Only sources in allowed_unverified_sources can proceed without verification.
    # All other sources (including unknown/future values) require verification.
    blocked_unverified_sources:
      - "ai"        # Deprecated: AI生成物は検証必須（whitelist modeで自動的にブロック）
      - "hybrid"    # Deprecated: ハイブリッド生成物も検証必須（whitelist modeで自動的にブロック）

# ============================================================================
# Rule Change History
# ============================================================================

change_history:
  - timestamp: "2026-02-08T12:00:00Z"
    changed_by: "System"
    rule: "meta.version"
    old_value: null
    new_value: "1.0"
    rationale: "初期バージョン作成"

  - timestamp: "2026-02-08T12:00:00Z"
    changed_by: "System"
    rule: "core_architecture"
    old_value: null
    new_value: "added"
    rationale: "Phase A-C完了に伴い、Core Architecture rulesを追加"
